#!/usr/bin/env just --justfile

set shell := ["bash", "-c"]
set dotenv-load := false

# Colors
_RED := '\033[0;31m'
_GREEN := '\033[0;32m'
_YELLOW := '\033[1;33m'
_BLUE := '\033[0;34m'
_NC := '\033[0m'

_print_success msg:
    @echo -e "{{ _GREEN }}✓ {{ msg }}{{ _NC }}"

_print_error msg:
    @echo -e "{{ _RED }}✗ {{ msg }}{{ _NC }}"

_print_info msg:
    @echo -e "{{ _BLUE }}ℹ {{ msg }}{{ _NC }}"

_print_warn msg:
    @echo -e "{{ _YELLOW }}⚠ {{ msg }}{{ _NC }}"

_check_tools:
    @command -v terraform >/dev/null 2>&1 || (just _print_error "terraform not found. Install Terraform >= 1.6"; exit 1)
    @command -v gcloud >/dev/null 2>&1 || (just _print_error "gcloud CLI not found. Install Google Cloud SDK"; exit 1)

# Helper to extract value from terraform.tfvars
_get_tfvar name:
    @grep '{{name}}' terraform.tfvars 2>/dev/null | grep -o '"[^"]*"' | head -1 | tr -d '"' || echo ""

# Helper to get all .tfvars files (portable: works on Linux and macOS)
_get_tfvars_files:
    @VAR_FILES=$(find config -name "*.tfvars" -type f 2>/dev/null | sed 's/^/-var-file=/' | tr '\n' ' '); echo $VAR_FILES

# Default: show available commands
default:
    @just --list

# ============================================================================
# BOOTSTRAP: Run this ONCE to set up initial infrastructure
# ============================================================================

# Complete bootstrap: create state bucket, enable APIs, apply initial config
bootstrap:
    #!/usr/bin/env bash
    set -e

    just _check_tools
    echo ""
    just _print_info "═══════════════════════════════════════════════════════"
    just _print_info "  Template GCP - Initial Setup"
    just _print_info "═══════════════════════════════════════════════════════"
    echo ""

    # Check terraform.tfvars exists
    if [ ! -f terraform.tfvars ]; then
        just _print_error "terraform.tfvars not found"
        just _print_info "Run: cp terraform.tfvars.example terraform.tfvars"
        just _print_info "Then edit terraform.tfvars with your project details"
        exit 1
    fi

    # Extract variables from terraform.tfvars
    PROJECT_ID=$(grep 'project_id' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)
    REGION=$(grep 'region' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)
    STATE_BUCKET=$(grep 'state_bucket[[:space:]]*=' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)
    STATE_BUCKET_CLASS=$(grep 'state_bucket_class[[:space:]]*=' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)
    REPOSITORY_ID=$(grep 'repository_id' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)
    GH_OWNER=$(echo $REPOSITORY_ID | cut -d'/' -f1)
    GH_REPO=$(echo $REPOSITORY_ID | cut -d'/' -f2)

    # WIF Configuration (extracted from tfvars)
    WIF_POOL_ID=$(grep 'workload_identity_pool_id' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)
    WIF_PROVIDER_ID=$(grep 'workload_identity_pool_provider_id' terraform.tfvars | grep -o '=[[:space:]]*"[^"]*"' | cut -d'"' -f2 | head -n 1)

    if [ -z "$PROJECT_ID" ]; then
        just _print_error "project_id not found in terraform.tfvars"
        exit 1
    fi
    if [ -z "$STATE_BUCKET" ]; then
        just _print_error "state_bucket not found in terraform.tfvars"
        exit 1
    fi
    if [ -z "$REGION" ]; then
        REGION="us-central1"
    fi
    if [ -z "$STATE_BUCKET_CLASS" ]; then
        STATE_BUCKET_CLASS="STANDARD"
    fi
    if [ -z "$GH_OWNER" ] || [ -z "$GH_REPO" ]; then
        just _print_error "repository_id not found or invalid in terraform.tfvars"
        exit 1
    fi
    if [ -z "$WIF_POOL_ID" ]; then
        just _print_error "workload_identity_pool_id not found in terraform.tfvars"
        exit 1
    fi
    if [ -z "$WIF_PROVIDER_ID" ]; then
        just _print_error "workload_identity_pool_provider_id not found in terraform.tfvars"
        exit 1
    fi

    echo ""
    just _print_info "Project ID.........: $PROJECT_ID"
    just _print_info "Region.............: $REGION"
    just _print_info "State Bucket.......: $STATE_BUCKET"
    just _print_info "Repository.........: $GH_OWNER/$GH_REPO"
    just _print_info "WIF Pool ID........: $WIF_POOL_ID"
    just _print_info "WIF Provider ID....: $WIF_PROVIDER_ID"
    echo ""

    # Step 1: Verify gcloud authentication
    just _print_info "[1/8] Verifying gcloud authentication..."
    if ! gcloud auth print-access-token >/dev/null 2>&1; then
        just _print_error "Not authenticated with gcloud"
        just _print_info "Run: gcloud auth login"
        exit 1
    fi
    if ! gcloud auth application-default print-access-token >/dev/null 2>&1; then
        just _print_error "Application Default Credentials (ADC) not found"
        just _print_info "Terraform requires ADC to authenticate"
        just _print_info "Run: gcloud auth application-default login"
        exit 1
    fi
    just _print_success "Authenticated (User & ADC)"

    # Step 2: Set project
    just _print_info "[2/8] Setting GCP project..."
    gcloud config set project $PROJECT_ID --quiet
    just _print_success "Project set to $PROJECT_ID"

    # Step 3: Enable required APIs
    just _print_info "[3/8] Enabling required APIs (this may take a minute)..."
    gcloud services enable storage.googleapis.com --quiet
    gcloud services enable iam.googleapis.com --quiet
    gcloud services enable cloudresourcemanager.googleapis.com --quiet
    gcloud services enable serviceusage.googleapis.com --quiet
    gcloud services enable iamcredentials.googleapis.com --quiet
    just _print_success "APIs enabled"

    # Step 4: Create WIF pool and provider
    just _print_info "[4/8] Creating Workload Identity Pool and Provider..."

    # Create Pool with auto-undelete logic
    if ! gcloud iam workload-identity-pools create "$WIF_POOL_ID" \
      --project="$PROJECT_ID" \
      --location="global" \
      --display-name="GitHub Actions pool" >/dev/null 2>&1; then

        POOL_STATE=$(gcloud iam workload-identity-pools describe "$WIF_POOL_ID" \
          --project="$PROJECT_ID" \
          --location="global" \
          --format="value(state)" 2>/dev/null || echo "MISSING")

        if [ "$POOL_STATE" = "DELETED" ]; then
            just _print_warn "Workload Identity Pool is DELETED. Undeleting..."
            gcloud iam workload-identity-pools undelete "$WIF_POOL_ID" \
              --project="$PROJECT_ID" \
              --location="global" >/dev/null
            just _print_success "Pool restored"
        else
            just _print_info "Workload Identity Pool already exists (Active)"
        fi
    fi

    # Create Provider
    if ! gcloud iam workload-identity-pools providers create-oidc "$WIF_PROVIDER_ID" \
      --project="$PROJECT_ID" \
      --location="global" \
      --workload-identity-pool="$WIF_POOL_ID" \
      --display-name="GitHub Actions provider" \
      --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
      --attribute-condition="attribute.repository == '$GH_OWNER/$GH_REPO'" \
      --issuer-uri="https://token.actions.githubusercontent.com" >/dev/null 2>&1; then

        # Check if it exists (Active or Deleted) using LIST (more robust for deleted items than describe)
        PROVIDER_STATE=$(gcloud iam workload-identity-pools providers list \
          --project="$PROJECT_ID" \
          --location="global" \
          --workload-identity-pool="$WIF_POOL_ID" \
          --show-deleted \
          --format="value(state)" \
          --filter="name:providers/$WIF_PROVIDER_ID" 2>/dev/null || echo "MISSING")

        # Fallback empty check
        if [ -z "$PROVIDER_STATE" ]; then PROVIDER_STATE="MISSING"; fi

        if [ "$PROVIDER_STATE" = "DELETED" ]; then
            just _print_warn "Workload Identity Provider is DELETED. Undeleting..."
            gcloud iam workload-identity-pools providers undelete "$WIF_PROVIDER_ID" \
              --project="$PROJECT_ID" \
              --location="global" \
              --workload-identity-pool="$WIF_POOL_ID" >/dev/null
            just _print_success "Provider restored"
        elif [ "$PROVIDER_STATE" = "ACTIVE" ] || [ "$PROVIDER_STATE" = "ENABLED" ]; then
            just _print_info "Workload Identity Provider already exists (Active)"
        else
            just _print_error "Failed to create Workload Identity Provider. State: $PROVIDER_STATE"
            exit 1
        fi
    fi

    just _print_success "Workload Identity Pool and Provider configured"

    # Step 5: Grant workloadIdentityUser role
    just _print_info "[5/8] Granting workloadIdentityUser role to sa-terraform..."
    SA_EMAIL="sa-terraform@$PROJECT_ID.iam.gserviceaccount.com"

    # Get project number (required for principalSet)
    PROJECT_NUMBER=$(gcloud projects describe "$PROJECT_ID" --format="value(projectNumber)")

    # Use principalSet for specific repository access (more secure and avoids 403 errors with conditions)
    MEMBER="principalSet://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$WIF_POOL_ID/attribute.repository/$GH_OWNER/$GH_REPO"

    gcloud iam service-accounts add-iam-policy-binding "$SA_EMAIL" \
      --project="$PROJECT_ID" \
      --role="roles/iam.workloadIdentityUser" \
      --member="$MEMBER" >/dev/null 2>&1 || just _print_info "IAM policy binding already exists"
    just _print_success "workloadIdentityUser role granted"

    # Step 5.5: Grant WorkloadIdentityPoolAdmin role (required for drift detection)
    just _print_info "[5.5/8] Granting WorkloadIdentityPoolAdmin role to sa-terraform..."
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --role="roles/iam.workloadIdentityPoolAdmin" \
      --member="serviceAccount:$SA_EMAIL" >/dev/null 2>&1 || just _print_info "IAM policy binding already exists"
    just _print_success "WorkloadIdentityPoolAdmin role granted"

    # Step 6: Create state bucket if not exists
    just _print_info "[6/8] Checking state bucket..."
    if gcloud storage ls gs://$STATE_BUCKET >/dev/null 2>&1; then
        just _print_success "State bucket already exists"
    else
        just _print_info "Creating state bucket: $STATE_BUCKET ($STATE_BUCKET_CLASS)"
        gcloud storage buckets create gs://$STATE_BUCKET --location=$REGION --default-storage-class=$STATE_BUCKET_CLASS --uniform-bucket-level-access
        gcloud storage buckets update gs://$STATE_BUCKET --versioning
        just _print_success "State bucket created with versioning"
    fi

    # Step 7: Terraform init
    just _print_info "[7/8] Initializing Terraform..."
    terraform init \
        -backend-config="bucket=$STATE_BUCKET" \
        -backend-config="prefix=terraform/state"
    just _print_success "Terraform initialized"

    # Step 7.5: Import WIF resources if they exist (to handle pre-bootstrap creation)
    just _print_info "[7.5/8] Checking existing WIF resources..."
    VAR_FILES=$(just _get_tfvars_files)

    # Import WIF Pool if it's not in state but exists in GCP
    if ! terraform state list | grep -q "google_iam_workload_identity_pool.main"; then
         just _print_info "Importing WIF Pool into Terraform state..."
         echo "Debug: Importing projects/$PROJECT_ID/locations/global/workloadIdentityPools/$WIF_POOL_ID"
         terraform import $VAR_FILES 'module.iam[0].module.iam_service_accounts.google_iam_workload_identity_pool.main[0]' "projects/$PROJECT_ID/locations/global/workloadIdentityPools/$WIF_POOL_ID" || just _print_warn "Import failed (ignoring if just failed)"
    fi

    # Import WIF Provider if it's not in state but exists in GCP
    if ! terraform state list | grep -q "google_iam_workload_identity_pool_provider.main"; then
         just _print_info "Importing WIF Provider into Terraform state..."
         echo "Debug: Importing projects/$PROJECT_ID/locations/global/workloadIdentityPools/$WIF_POOL_ID/providers/$WIF_PROVIDER_ID"
         terraform import $VAR_FILES 'module.iam[0].module.iam_service_accounts.google_iam_workload_identity_pool_provider.main[0]' "projects/$PROJECT_ID/locations/global/workloadIdentityPools/$WIF_POOL_ID/providers/$WIF_PROVIDER_ID"
    fi

    # Step 8: Terraform apply
    just _print_info "[8/8] Applying initial configuration..."
    terraform plan -out=tfplan $VAR_FILES
    echo ""
    just _print_warn "Review the plan above. Continue with apply? (yes/no)"
    read -p "> " confirm
    if [ "$confirm" = "yes" ]; then
        terraform apply tfplan
        rm -f tfplan
        just _print_success "Initial infrastructure created"
    else
        rm -f tfplan
        just _print_warn "Apply cancelled. Run 'just pre-bootstrap' again when ready."
        exit 0
    fi

    echo ""
    just _print_success "═══════════════════════════════════════════════════════"
    just _print_success "  Pre-bootstrap complete!"
    just _print_success "═══════════════════════════════════════════════════════"
    echo ""
    just _print_info "Next steps:"

    just _print_info "  1. Configure GitHub repository variables:"
    just _print_info "     - GCP_PROJECT_ID: your project ID"
    just _print_info "     - GCP_STATE_BUCKET: your state bucket name"
    just _print_info ""
    just _print_info "  2. Set up GitHub Environment protection:"
    just _print_info "     Settings → Environments → prd → Required reviewers"
    just _print_info ""
    just _print_info "  3. From now on, make changes via Pull Requests:"
    just _print_info "     - Edit files in config/ directory"
    just _print_info "     - Commit and push"
    just _print_info "     - Open PR → Review plan → Approve → Merge"
    echo ""

# ============================================================================
# LOCAL CONVENIENCE COMMANDS (for development/testing only)
# ============================================================================

# Initialize Terraform (connects to remote state)
init:
    @just _check_tools
    @if [ ! -f terraform.tfvars ]; then \
        just _print_error "terraform.tfvars not found"; \
        exit 1; \
    fi
    @STATE_BUCKET=$(grep 'state_bucket' terraform.tfvars | grep -o '"[^"]*"' | head -1 | tr -d '"'); \
    if [ -z "$STATE_BUCKET" ]; then \
        just _print_error "state_bucket not found in terraform.tfvars"; \
        exit 1; \
    fi; \
    just _print_info "Initializing Terraform with state bucket: $STATE_BUCKET"; \
    terraform init \
        -backend-config="bucket=$STATE_BUCKET" \
        -backend-config="prefix=terraform/state"
    @just _print_success "Terraform initialized"

# Format Terraform files
fmt:
    @just _print_info "Formatting Terraform files..."
    @terraform fmt -recursive .
    @just _print_success "Formatted"

# Validate Terraform configuration (auto-inits without backend if needed)
validate:
    @just _check_tools
    @if [ ! -d ".terraform" ]; then \
        just _print_info "Initializing modules (backend disabled)..."; \
        terraform init -backend=false -input=false >/dev/null 2>&1; \
    fi
    @just _print_info "Validating Terraform configuration..."
    @terraform validate
    @just _print_success "Valid"

# Run terraform plan (for local testing only - use CI/CD for real changes)
plan:
    @just _print_warn "NOTE: For real infrastructure changes, use Pull Requests."
    @just _print_info "This is for local testing/preview only."
    @echo ""
    @just _check_tools
    @if [ ! -d ".terraform" ]; then \
        just _print_error "Terraform not initialized"; \
        just _print_info "Please run 'just init' first"; \
        exit 1; \
    fi
    @VAR_FILES=$(just _get_tfvars_files); \
    terraform plan -out=tfplan $VAR_FILES
    @echo ""
    @just _print_success "Plan saved to 'tfplan'"
    @just _print_info "To inspect details run: terraform show tfplan"

# Show current state
show:
    @terraform show

# Show outputs
output:
    @terraform output

# Lint with tflint (optional)
lint:
    @command -v tflint >/dev/null 2>&1 || (just _print_error "tflint not found"; exit 1)
    @just _print_info "Running tflint..."
    @tflint --init 2>/dev/null || true
    @tflint
    @just _print_success "Linting passed"

# Generate documentation for all modules
docs:
    @command -v terraform-docs >/dev/null 2>&1 || (just _print_error "terraform-docs not found"; exit 1)
    @just _print_info "Generating Terraform documentation..."
    @terraform-docs --config ../.terraform-docs.yml .
    @for dir in modules/*; do \
        if [ -d "$$dir" ]; then \
            terraform-docs --config ../.terraform-docs.yml "$$dir"; \
        fi \
    done
    @just _print_success "Documentation updated"

# ============================================================================
# HELPER COMMANDS
# ============================================================================

# Quick setup: create terraform.tfvars from example
quickstart:
    @just _check_tools
    @if [ -f terraform.tfvars ]; then \
        just _print_warn "terraform.tfvars already exists"; \
    else \
        cp terraform.tfvars.example terraform.tfvars; \
        just _print_success "Created terraform.tfvars from example"; \
    fi
    @echo ""
    @just _print_info "Next steps:"
    @just _print_info "  1. Edit terraform.tfvars with your values:"
    @just _print_info "     - project_id"
    @just _print_info "     - state_bucket"
    @just _print_info "     - region"
    @just _print_info "     - environment"
    @just _print_info "  2. Run: just bootstrap"

# Show help
help:
    @echo ""
    @just _print_info "Template GCP - Available Commands"
    @echo ""
    @echo ""
    @echo "  Initial Setup (run once):"
    @echo "    just quickstart      Create terraform.tfvars from example"
    @echo "    just bootstrap       Complete initial GCP setup (State bucket, APIs, WIF)"
    @echo ""
    @echo "  Local Development (Validation):"
    @echo "    just init            Initialize Terraform (reconnect to state)"
    @echo "    just plan            Preview changes (Use this to validate before PR)"
    @echo "    just fmt             Format Terraform files"
    @echo "    just validate        Validate configuration"
    @echo "    just lint            Run tflint"
    @echo ""
    @echo "  Deployment:"
    @echo "    All infrastructure changes must be done via Pull Requests (CI/CD)."
    @echo "    1. just plan (Validate locally)"
    @echo "    2. git commit & push"
    @echo "    3. Create PR (Auto-plan)"
    @echo "    4. Merge (Auto-apply)"
    @echo ""
