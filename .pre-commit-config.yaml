# =============================================================================
# Pre-commit Configuration
# =============================================================================
#
# This file configures pre-commit hooks for code quality and security checks.
#
# Setup:
#   pip install pre-commit
#   pre-commit install
#
# Manual run:
#   pre-commit run --all-files
#
# Update hooks:
#   pre-commit autoupdate
#
# =============================================================================
default_install_hook_types: [pre-commit, commit-msg]

exclude: |
  (?x)^(
      ^.*\.terraform/.*$
  )

repos:
  # ---------------------------------------------------------------------------
  # Local Hooks (System - Managed via pyproject.toml/uv)
  # ---------------------------------------------------------------------------
  - repo: local
    hooks:
      # Linting & Formatting (Python)
      - id: ruff
        name: ruff
        entry: uv run ruff check
        args: [--force-exclude, --fix]
        language: system
        types: [python]
      - id: ruff-format
        name: ruff-format
        entry: uv run ruff format
        language: system
        types: [python]

      # Security (IaC)
      - id: checkov
        name: checkov
        entry: uv run checkov
        language: system
        files: \.tf$
        args:
          - --quiet
          - --config-file
          - terraform/policies/checkov/.checkov.yaml
          - -d
          - terraform
        pass_filenames: false

      # Commit Messages
      - id: commitizen
        name: commitizen
        entry: uv run cz check
        args: [--allow-abort, --commit-msg-file]
        language: system
        stages: [commit-msg]

  # ---------------------------------------------------------------------------
  # General Hooks
  # ---------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        exclude: \.md$
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--unsafe]
      - id: check-json
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-merge-conflict
      - id: detect-private-key
      - id: no-commit-to-branch
        args: [--branch, main, --branch, master]

  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.10
    hooks:
      - id: actionlint

  # ---------------------------------------------------------------------------
  # Terraform Hooks
  # ---------------------------------------------------------------------------
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.105.0
    hooks:
      - id: terraform_fmt
        args:
          - --args=-recursive
      - id: terraform_validate
        args:
          - --hook-config=--retry-once-with-cleanup=true
      - id: terraform_tflint
        args:
          - --args=--config=__GIT_WORKING_DIR__/.tflint.hcl

  # ---------------------------------------------------------------------------
  # Security Hooks
  # ---------------------------------------------------------------------------
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args:
          - --baseline
          - .secrets.baseline
        exclude: \.terraform/|\.terraform\.lock\.hcl

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks

  # ---------------------------------------------------------------------------
  # Markdown Hooks
  # ---------------------------------------------------------------------------
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        args: [--fix, --disable, MD013, MD033, MD041, --]
        exclude: ^terraform/modules/.*/README\.md$
